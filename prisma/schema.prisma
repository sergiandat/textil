generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  TALLER
  MARCA
  ESTADO
  ADMIN
}

enum NivelTaller {
  BRONCE
  PLATA
  ORO
}

enum EstadoPedido {
  BORRADOR
  EN_EJECUCION
  ESPERANDO_ENTREGA
  COMPLETADO
  CANCELADO
}

enum EstadoOrdenManufactura {
  PENDIENTE
  EN_EJECUCION
  COMPLETADO
  CANCELADO
}

enum EstadoEscrow {
  BLOQUEADO
  PENDIENTE
  LIBERADO
  DISPUTADO
}

enum EstadoValidacion {
  NO_INICIADO
  PENDIENTE
  COMPLETADO
  VENCIDO
  RECHAZADO
}

enum TipoAuditoria {
  PRIMERA_VISITA
  VERIFICACION
  SEGUIMIENTO
  RE_AUDITORIA
}

enum EstadoAuditoria {
  PROGRAMADA
  EN_CURSO
  COMPLETADA
  CANCELADA
}

enum EstadoDenuncia {
  RECIBIDA
  EN_INVESTIGACION
  RESUELTA
  DESESTIMADA
}

enum CanalNotificacion {
  EMAIL
  WHATSAPP
  PUSH
  PLATAFORMA
}

enum EstadoAccionCorrectiva {
  PENDIENTE
  EN_PROCESO
  COMPLETADA
  VENCIDA
}

// ============================================
// AUTH & USERS
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime?
  password      String?
  name          String?
  phone         String?
  avatar        String?
  role          UserRole  @default(TALLER)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  taller        Taller?
  marca         Marca?
  accounts      Account[]
  sessions      Session[]
  notificaciones Notificacion[]
  logs          LogActividad[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// TALLERES
// ============================================

model Taller {
  id                    String      @id @default(cuid())
  userId                String      @unique
  nombre                String
  cuit                  String      @unique
  nivel                 NivelTaller @default(BRONCE)
  puntaje               Int         @default(0)
  rating                Float       @default(0)
  ubicacion             String?
  zona                  String?
  descripcion           String?     @db.Text
  capacidadMensual      Int         @default(0)
  trabajadoresRegistrados Int       @default(0)
  fundado               Int?
  verificadoAfip        Boolean     @default(false)
  pedidosCompletados    Int         @default(0)
  ontimeRate            Float       @default(0)
  retrabajoRate         Float       @default(0)
  portfolioFotos        String[]

  // Wizard perfil (pasos 1-11)
  sam                   Int?
  prendaPrincipal       String?
  organizacion          String?
  metrosCuadrados       Int?
  areas                 String[]
  experienciaPromedio   String?
  polivalencia          String?
  horario               String?
  registroProduccion    String?
  escalabilidad         String?
  paradasFrecuencia     String?

  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  procesos              TallerProceso[]
  prendas               TallerPrenda[]
  maquinaria            Maquinaria[]
  certificaciones       TallerCertificacion[]
  validaciones          Validacion[]
  ordenesManufactura    OrdenManufactura[]
  auditorias            Auditoria[]
  denuncias             Denuncia[]
  progresoCapacitacion  ProgresoCapacitacion[]
  certificados          Certificado[]

  @@map("talleres")
}

// ============================================
// MARCAS
// ============================================

model Marca {
  id                String   @id @default(cuid())
  userId            String   @unique
  nombre            String
  cuit              String   @unique
  ubicacion         String?
  tipo              String?
  website           String?
  volumenMensual    Int      @default(0)
  frecuenciaCompra  String?
  rating            Float    @default(0)
  pedidosRealizados Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pedidos           Pedido[]

  @@map("marcas")
}

// ============================================
// PROCESOS Y PRENDAS (Catálogos)
// ============================================

model ProcesoProductivo {
  id          String   @id @default(cuid())
  nombre      String   @unique
  descripcion String?  @db.Text
  maquinaria  String[]
  tiempoEstimado500u String?
  activo      Boolean  @default(true)

  talleres    TallerProceso[]
  prendaProcesos PrendaProceso[]

  @@map("procesos_productivos")
}

model TipoPrenda {
  id              String   @id @default(cuid())
  nombre          String   @unique
  precioReferencia Float?
  variantes       String[]
  activo          Boolean  @default(true)

  talleres        TallerPrenda[]
  procesos        PrendaProceso[]

  @@map("tipos_prenda")
}

model PrendaProceso {
  id        String @id @default(cuid())
  prendaId  String
  procesoId String
  orden     Int    @default(0)

  prenda  TipoPrenda       @relation(fields: [prendaId], references: [id], onDelete: Cascade)
  proceso ProcesoProductivo @relation(fields: [procesoId], references: [id], onDelete: Cascade)

  @@unique([prendaId, procesoId])
  @@map("prenda_procesos")
}

model TallerProceso {
  id        String @id @default(cuid())
  tallerId  String
  procesoId String
  precio    Float?

  taller  Taller            @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  proceso ProcesoProductivo @relation(fields: [procesoId], references: [id], onDelete: Cascade)

  @@unique([tallerId, procesoId])
  @@map("taller_procesos")
}

model TallerPrenda {
  id       String @id @default(cuid())
  tallerId String
  prendaId String

  taller Taller     @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  prenda TipoPrenda @relation(fields: [prendaId], references: [id], onDelete: Cascade)

  @@unique([tallerId, prendaId])
  @@map("taller_prendas")
}

model Maquinaria {
  id       String @id @default(cuid())
  tallerId String
  nombre   String
  cantidad Int    @default(1)
  tipo     String?

  taller Taller @relation(fields: [tallerId], references: [id], onDelete: Cascade)

  @@map("maquinaria")
}

model TallerCertificacion {
  id          String    @id @default(cuid())
  tallerId    String
  nombre      String
  vencimiento DateTime?
  activa      Boolean   @default(true)

  taller Taller @relation(fields: [tallerId], references: [id], onDelete: Cascade)

  @@map("taller_certificaciones")
}

// ============================================
// PEDIDOS Y ÓRDENES DE MANUFACTURA
// ============================================

model Pedido {
  id            String       @id @default(cuid())
  omId          String       @unique
  marcaId       String
  tipoPrenda    String
  cantidad      Int
  fechaCreacion DateTime     @default(now())
  fechaObjetivo DateTime?
  estado        EstadoPedido @default(BORRADOR)
  progresoTotal Float        @default(0)
  montoTotal    Float        @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  marca         Marca        @relation(fields: [marcaId], references: [id])
  ordenes       OrdenManufactura[]

  @@map("pedidos")
}

model OrdenManufactura {
  id              String                   @id @default(cuid())
  moId            String                   @unique
  pedidoId        String
  tallerId        String
  proceso         String
  estado          EstadoOrdenManufactura   @default(PENDIENTE)
  progreso        Float                    @default(0)
  precio          Float                    @default(0)
  plazoDias       Int?
  diasTranscurridos Int                    @default(0)
  verificacionSst Boolean                  @default(false)
  alertaTiempo    String?
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  pedido          Pedido   @relation(fields: [pedidoId], references: [id], onDelete: Cascade)
  taller          Taller   @relation(fields: [tallerId], references: [id])
  hitos           EscrowHito[]

  @@map("ordenes_manufactura")
}

model EscrowHito {
  id                  String       @id @default(cuid())
  ordenManufacturaId  String
  nombre              String
  porcentaje          Float
  monto               Float
  estado              EstadoEscrow @default(BLOQUEADO)

  ordenManufactura OrdenManufactura @relation(fields: [ordenManufacturaId], references: [id], onDelete: Cascade)

  @@map("escrow_hitos")
}

// ============================================
// FORMALIZACIÓN
// ============================================

model Validacion {
  id              String           @id @default(cuid())
  tallerId        String
  tipo            String
  estado          EstadoValidacion @default(NO_INICIADO)
  detalle         String?
  documentoUrl    String?
  fechaVencimiento DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  taller Taller @relation(fields: [tallerId], references: [id], onDelete: Cascade)

  @@unique([tallerId, tipo])
  @@map("validaciones")
}

model TipoDocumento {
  id          String  @id @default(cuid())
  nombre      String  @unique
  descripcion String?
  requerido   Boolean @default(true)
  activo      Boolean @default(true)

  @@map("tipos_documento")
}

// ============================================
// ACADEMIA (Capacitación)
// ============================================

model Coleccion {
  id           String   @id @default(cuid())
  titulo       String
  descripcion  String?  @db.Text
  categoria    String?
  duracion     String?
  calificacion Float    @default(0)
  institucion  String?
  orden        Int      @default(0)
  activa       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  videos       Video[]
  evaluacion   Evaluacion?
  certificados Certificado[]
  progreso     ProgresoCapacitacion[]

  @@map("colecciones")
}

model Video {
  id          String @id @default(cuid())
  coleccionId String
  titulo      String
  youtubeUrl  String
  duracion    String?
  orden       Int    @default(0)

  coleccion Coleccion @relation(fields: [coleccionId], references: [id], onDelete: Cascade)

  @@map("videos")
}

model Evaluacion {
  id          String @id @default(cuid())
  coleccionId String @unique
  preguntas   Json
  puntajeMinimo Int  @default(60)

  coleccion Coleccion @relation(fields: [coleccionId], references: [id], onDelete: Cascade)

  @@map("evaluaciones")
}

model Certificado {
  id          String   @id @default(cuid())
  tallerId    String
  coleccionId String
  codigo      String   @unique
  fecha       DateTime @default(now())
  calificacion Int
  revocado    Boolean  @default(false)

  taller    Taller    @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  coleccion Coleccion @relation(fields: [coleccionId], references: [id])

  @@map("certificados")
}

model ProgresoCapacitacion {
  id                  String @id @default(cuid())
  tallerId            String
  coleccionId         String
  porcentajeCompletado Float  @default(0)
  videosVistos        Int    @default(0)
  updatedAt           DateTime @updatedAt

  taller    Taller    @relation(fields: [tallerId], references: [id], onDelete: Cascade)
  coleccion Coleccion @relation(fields: [coleccionId], references: [id], onDelete: Cascade)

  @@unique([tallerId, coleccionId])
  @@map("progreso_capacitacion")
}

// ============================================
// AUDITORÍAS
// ============================================

model Auditoria {
  id          String           @id @default(cuid())
  tallerId    String
  inspectorId String?
  fecha       DateTime?
  tipo        TipoAuditoria    @default(PRIMERA_VISITA)
  prioridad   String?
  estado      EstadoAuditoria  @default(PROGRAMADA)
  resultado   String?
  hallazgos   Json?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  taller      Taller @relation(fields: [tallerId], references: [id])
  acciones    AccionCorrectiva[]

  @@map("auditorias")
}

model AccionCorrectiva {
  id          String                   @id @default(cuid())
  auditoriaId String
  descripcion String
  estado      EstadoAccionCorrectiva   @default(PENDIENTE)
  plazo       DateTime?
  evidenciaUrl String?

  auditoria Auditoria @relation(fields: [auditoriaId], references: [id], onDelete: Cascade)

  @@map("acciones_correctivas")
}

// ============================================
// DENUNCIAS
// ============================================

model Denuncia {
  id          String          @id @default(cuid())
  tipo        String
  tallerId    String?
  descripcion String          @db.Text
  estado      EstadoDenuncia  @default(RECIBIDA)
  anonima     Boolean         @default(false)
  codigo      String          @unique
  evidenciaUrl String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  taller Taller? @relation(fields: [tallerId], references: [id])

  @@map("denuncias")
}

// ============================================
// NOTIFICACIONES
// ============================================

model Notificacion {
  id      String             @id @default(cuid())
  userId  String
  tipo    String
  titulo  String
  mensaje String             @db.Text
  leida   Boolean            @default(false)
  canal   CanalNotificacion  @default(PLATAFORMA)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notificaciones")
}

// ============================================
// CONFIGURACIÓN Y SISTEMA
// ============================================

model ConfiguracionSistema {
  id    String @id @default(cuid())
  clave String @unique
  valor String @db.Text
  grupo String?

  @@map("configuracion_sistema")
}

model LogActividad {
  id        String   @id @default(cuid())
  userId    String?
  accion    String
  detalles  Json?
  ip        String?
  timestamp DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@map("log_actividad")
}
