<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Plataforma Textil OIT</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="feedback.css">
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-content">
      <div class="topbar-logo">
        <div class="logo-icon">PT</div>
        <div>
          <div class="text-sm font-semibold text-slate-900">Plataforma Textil</div>
          <div class="text-xs text-slate-500">Marca: <span id="marcaNombre">Urbano Kids</span></div>
        </div>
      </div>

      <nav class="topbar-nav">
        <button class="nav-tab active" onclick="window.location.href='dashboard.html'">Dashboard</button>
        <button class="nav-tab" onclick="mostrarModalVersionPedido()">Crear Pedido</button>
        <button class="nav-tab" onclick="alert('Mis Pedidos: Ver en Dashboard')">Mis Pedidos</button>
        <button class="nav-tab" onclick="window.location.href='explorar-talleres.html'">Explorar Talleres</button>
      </nav>

      <div class="flex items-center gap-3">
        <button class="btn btn-secondary" onclick="window.location.href='perfil-marca.html'" style="display: flex; align-items: center; gap: 0.5rem;">
          Mi Perfil
        </button>
        <span class="pill pill-sky">v1.3</span>
        <button class="btn btn-secondary" onclick="if(confirm('¬øCerrar sesi√≥n?')) window.location.href='index.html'">Salir</button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Vista general de tu actividad en la plataforma</p>
      </div>
      <div class="flex gap-2">
        <span class="badge badge-emerald">Formalidad</span>
        <span class="badge badge-slate">Rating: 4.8‚òÖ</span>
      </div>
    </div>

    <!-- KPIs -->
    <div class="grid grid-cols-4 gap-4 mb-6">
      <div class="stat-card">
        <div class="stat-value" id="statPedidosActivos">2</div>
        <div class="stat-label">Pedidos activos</div>
        <div class="stat-hint">En ejecuci√≥n</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPedidosCompletados">12</div>
        <div class="stat-label">Pedidos completados</div>
        <div class="stat-hint">√öltimo mes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statMontoTransaccionado">$2.3M</div>
        <div class="stat-label">Monto transaccionado</div>
        <div class="stat-hint">√öltimos 30 d√≠as</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statRating">4.8‚òÖ</div>
        <div class="stat-label">Calificaci√≥n promedio</div>
        <div class="stat-hint">12 calificaciones</div>
      </div>
    </div>

    <!-- Acciones r√°pidas -->
    <div class="section-card mb-6">
      <h3 class="section-title mb-4">Acciones r√°pidas</h3>
      <div class="grid grid-cols-3 gap-3">
        <button class="btn btn-primary btn-lg" onclick="mostrarModalVersionPedido()">
          Crear nuevo pedido
        </button>
        <button class="btn btn-secondary btn-lg" onclick="window.location.href='explorar-talleres.html'">
          Explorar talleres
        </button>
        <button class="btn btn-secondary btn-lg" onclick="alert('Ver contratos activos')">
          Ver contratos activos
        </button>
      </div>
    </div>

    <!-- Pedidos activos -->
    <div class="section-card mb-6">
      <div class="section-header">
        <div>
          <h3 class="section-title">Pedidos activos</h3>
          <p class="section-subtitle">Seguimiento en tiempo real</p>
        </div>
      </div>

      <div id="pedidosActivosContainer" class="space-y-4">
        <!-- Se llena din√°micamente con JS -->
      </div>
    </div>

    <!-- Alertas / Notificaciones -->
    <div class="section-card">
      <div class="section-header">
        <div>
          <h3 class="section-title">Alertas y notificaciones</h3>
          <p class="section-subtitle">Acciones pendientes</p>
        </div>
      </div>

      <div id="alertasContainer" class="space-y-2">
        <!-- Se llena din√°micamente con JS -->
      </div>
    </div>

    <!-- Exportar Feedback MVP v1.1 -->
    <div class="section-card" style="margin-top: 2rem;">
      <div class="section-header">
        <div>
          <h3 class="section-title">Feedback del MVP</h3>
          <p class="section-subtitle">Exportar todas las respuestas recolectadas</p>
        </div>
      </div>

      <div class="feedback-export-section" style="background: var(--sky-50); border: 2px dashed var(--sky-300); border-radius: 1rem; padding: 1.5rem; text-align: center;">
        <div style="font-size: 1rem; font-weight: 600; color: var(--slate-900); margin-bottom: 0.5rem;">
          üìù Exportar Feedback
        </div>
        <div style="font-size: 0.875rem; color: var(--slate-600); margin-bottom: 1rem;">
          Descarg√° todas las respuestas del sistema de feedback integrado
        </div>
        <div class="feedback-count" style="justify-content: center; margin-bottom: 1rem;">
          <span>Respuestas recolectadas:</span>
          <span class="feedback-count-number" id="feedbackCountTotal">0</span>
        </div>
        <button
          class="feedback-export-btn"
          id="exportFeedbackBtn"
          onclick="exportarFeedbackCompleto()"
          style="padding: 0.75rem 1.5rem; background: var(--sky-600); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 0.5rem;"
        >
          üì• Descargar Feedback Completo
        </button>
      </div>
    </div>

  </main>

  <!-- Modal para elegir versi√≥n de Crear Pedido -->
  <div id="modalVersionPedido" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; border-radius: 1rem; padding: 2rem; max-width: 500px; width: 90%;">
      <h3 style="font-size: 1.25rem; font-weight: 600; color: var(--slate-900); margin-bottom: 1rem;">Elegir version de Crear Pedido</h3>
      <p style="color: var(--slate-600); margin-bottom: 1.5rem; font-size: 0.875rem;">Selecciona que version del flujo de creacion de pedido queres usar:</p>

      <div style="display: flex; flex-direction: column; gap: 1rem;">
        <button class="btn btn-secondary btn-lg" onclick="window.location.href='crear-pedido.html'" style="justify-content: space-between; display: flex; align-items: center;">
          <span>Crear Pedido v1.1</span>
          <span style="font-size: 0.75rem; opacity: 0.7;">(Version anterior)</span>
        </button>

        <button class="btn btn-primary btn-lg" onclick="window.location.href='crear-pedido-v1.3.html'" style="justify-content: space-between; display: flex; align-items: center;">
          <span>Crear Pedido v1.3</span>
          <span class="badge badge-emerald" style="font-size: 0.75rem;">NUEVO</span>
        </button>
      </div>

      <button class="btn btn-secondary btn-block" onclick="cerrarModalVersionPedido()" style="margin-top: 1.5rem;">
        Cancelar
      </button>
    </div>
  </div>

  <script src="data.js"></script>
  <script src="script.js"></script>
  <script src="feedback.js"></script>
  <script src="navigation-controller.js"></script>
  <script>
    // Cargar usuario de sesi√≥n
    const usuario = getFromLocalStorage('usuarioActivo') || usuarioActivo;
    document.getElementById('marcaNombre').textContent = usuario.nombre;

    // Cargar KPIs
    document.getElementById('statPedidosActivos').textContent = pedidosActivos.length;
    document.getElementById('statPedidosCompletados').textContent = pedidosCompletados.length;

    const montoTotal = pedidosActivos.reduce((sum, p) => sum + p.monto_total, 0) +
                       pedidosCompletados.reduce((sum, p) => sum + p.monto_total, 0);
    document.getElementById('statMontoTransaccionado').textContent = formatMoney(montoTotal);

    // Renderizar pedidos activos
    const pedidosContainer = document.getElementById('pedidosActivosContainer');

    if (pedidosActivos.length === 0) {
      pedidosContainer.innerHTML = '<p class="text-sm text-slate-500">No ten√©s pedidos activos. <a href="crear-pedido.html" class="text-sky-600">Cre√° tu primer pedido</a></p>';
    } else {
      pedidosActivos.forEach(pedido => {
        const progreso = calculateProgresoTotal(pedido.eslabones);

        const card = document.createElement('div');
        card.style.cssText = 'border: 1px solid var(--slate-200); border-radius: 0.75rem; padding: 1rem; cursor: pointer; transition: all 0.2s;';
        card.onmouseover = function() { this.style.backgroundColor = 'var(--slate-50)'; };
        card.onmouseout = function() { this.style.backgroundColor = 'white'; };
        card.onclick = function() { window.location.href = 'ejecucion.html?om=' + pedido.om_id; };

        card.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <div>
              <div class="font-semibold text-slate-900">${pedido.om_id} | ${pedido.tipo_prenda} ${pedido.cantidad}u</div>
              <div class="text-xs text-slate-500">Creado: ${formatDate(pedido.fecha_creacion)} | Objetivo: ${formatDate(pedido.fecha_objetivo)}</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-sky-600">${progreso}%</div>
              <div class="text-xs text-slate-500">${calculateDaysRemaining(pedido.fecha_objetivo)}</div>
            </div>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${progreso}%"></div>
          </div>
          <div class="mt-2 text-xs text-slate-600">
            ${pedido.eslabones.map(e => `${e.proceso}: ${e.progreso}%`).join(' | ')}
          </div>
        `;

        pedidosContainer.appendChild(card);
      });
    }

    // Renderizar alertas
    const alertasContainer = document.getElementById('alertasContainer');

    const alertas = [
      {
        tipo: 'warning',
        mensaje: `‚ö†Ô∏è ${pedidosActivos[0].om_id}: Taller solicita replanificaci√≥n (+2 d√≠as)`,
        accion: 'Ver pedido',
        link: 'ejecucion.html?om=' + pedidosActivos[0].om_id
      },
      {
        tipo: 'success',
        mensaje: `‚úì ${pedidosActivos[1].om_id}: Escrow liberado ($420K)`,
        accion: 'Ver detalles',
        link: 'ejecucion.html?om=' + pedidosActivos[1].om_id
      }
    ];

    alertas.forEach(alerta => {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${alerta.tipo}`;
      alertDiv.innerHTML = `
        <div class="flex items-center justify-between">
          <span class="text-sm">${alerta.mensaje}</span>
          <a href="${alerta.link}" class="btn btn-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
            ${alerta.accion}
          </a>
        </div>
      `;
      alertasContainer.appendChild(alertDiv);
    });

    // Marcar nav activo
    setActiveNav('dashboard');

    // Funci√≥n para exportar feedback completo
    function exportarFeedbackCompleto() {
      const txtContent = FeedbackManager.exportAllFeedback();

      // Crear blob y descargar
      const blob = new Blob([txtContent], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `feedback-mvp-v1.1-${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      showToast('‚úì Feedback exportado correctamente', 'success');
    }

    // Actualizar contador de respuestas
    function actualizarContadorFeedback() {
      const responses = JSON.parse(localStorage.getItem('feedbackResponses') || '{}');
      const contextualResponses = JSON.parse(localStorage.getItem('contextualFeedback') || '{}');

      let totalAnswered = 0;

      // Contar respuestas del panel
      Object.keys(responses).forEach(page => {
        const pageResponses = responses[page];
        Object.values(pageResponses).forEach(value => {
          if (Array.isArray(value) && value.length > 0) totalAnswered++;
          else if (value && value !== '') totalAnswered++;
        });
      });

      // Contar respuestas contextuales
      Object.keys(contextualResponses).forEach(feature => {
        totalAnswered += contextualResponses[feature].length;
      });

      document.getElementById('feedbackCountTotal').textContent = totalAnswered;
    }

    // Ejecutar al cargar
    actualizarContadorFeedback();

    // Funciones para modal de versi√≥n
    function mostrarModalVersionPedido() {
      document.getElementById('modalVersionPedido').style.display = 'flex';
    }

    function cerrarModalVersionPedido() {
      document.getElementById('modalVersionPedido').style.display = 'none';
    }
  </script>

</body>
</html>
